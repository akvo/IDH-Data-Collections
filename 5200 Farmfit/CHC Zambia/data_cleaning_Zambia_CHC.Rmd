---
title: "data_cleaning_Zambia_CHC"
author: "Ines Lesire"
date: "2023-01-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data cleaning

### Preparation

Load the necessary packages.

```{r, include = FALSE}

library(here); library(readxl); library(openxlsx);
library(plyr); library(dplyr); library(tidyr); library(tidylog); library(tidyselect)
library(stringr); library(data.table); library(reshape2)
library(zoo);library(splitstackshape) ;library(tidyverse)
```

Provide the basic case information.

```{r}
case = "CHC Zambia"
sdm_crop_1 = "maize"
sdm_crop_2 = "soybeans"
country = "Zambia"
```

Make a new Github map with the project name where this R Markdown file is stored, together with the other files needed for analysis. Describe the files here, so that the local names can be used further in the script.

```{r}
##DOWNLOAD THESE ALL TOGETHER IN A FOLDER AND RENAME THEM 
pi_filename <- "pi_2022_CHC_maize_soybeans.xlsx"
data_filename <- "391190273_CHC_maize_soybeans_raw_data.xlsx"
survey_filename <- "survey_CHC_maize_soybeans.xlsx"
data_delivery <- "2022_CHC_anom_maize_soybeans.xlsx"

```

Import the data files that can be found in the map Analytics-Guild -\> IDH -\> Templates and input files for data delivery. Copy them in the project map.

```{r}
question_library <- read_excel("question library format v3.1.1.xlsx",
                               sheet = "Full Survey", skip = 2) 
vars_transformed <- read_excel("variables with transformation.xlsx") 
household_demographics  <- read_excel("household_demographics_var.xlsx") 
vars_dashboard <- read_excel("variable names input dashboard.xlsx") 

```

Define funtions that will be needed later in the script.

```{r}
# DATA TYPE Set factors to integers
factor_to_int <- function(x){
  as.numeric(as.character(x))
}
# Find and replace outliers
outlier_detection <- function(x){
  ifelse(
    x > (mean(x, na.rm=TRUE) + sd(x, na.rm=TRUE)*3) |
      x < (mean(x, na.rm=TRUE) - sd(x, na.rm=TRUE)*3), 
    9997,
    x
  )
}
options(scipen = 999)  
# count values without NA
count_n <- function(x){sum(!is.na(x))}
```

### Import data from Flow

Import raw data that will be cleaned (Data) Import the raw data, without the personal information variables. (Data_raw) Import the survey file for this case.

```{r}
##  ---- Import data ----
# Read data from the data folder
Data <- read_excel(data_filename)
Data_raw <- read_excel(data_filename)

Data_raw <- Data_raw %>%
  select(-starts_with("pi_"), -name_of_farmer, -mobile_number_farmer)


# Read file with survey structure
survey_questions <- read_excel((survey_filename),sheet ="Full Survey", skip=2)

```

### Survey adjustments and basic information

Adjust the survey file to be ready for analysis.

```{r, include = FALSE}

survey_questions %<>% 
  # Fill excel merged cells from the section
  mutate(Title = na.locf(Title, na.rm = FALSE)) %>%
  # Select right columns
  select("Title", "Variable name", "Text",
         "Question type", "Options",
         "Allow multiple") %>%
  # Trim trailing spaces
  mutate_if(is.character, str_trim) %>%
  # Rename columns
  rename("section" = "Title", 
         "variable" = "Variable name", 
         "question" = "Text",
         "type" = "Question type", 
         "options" = "Options",
         "multiple" = "Allow multiple") %>%
  # All variables to lowercase
  mutate_all(tolower) %>%
  # Filter the empty variables
  filter(!is.na(variable)) 
```

We now have a clear overview of the survey questions asked in this case:

```{r}
head(survey_questions)
```

What are the numerical columns? How many participants?

```{r}
# Collect the different variables, numerical questions:
numerical_columns <- survey_questions %>%
  filter(type == "number") %>%
  select("variable") %>% pull()

## ---- Count initial number of participants
nr_participants_raw <- length(unique(Data$Identifier))
```

### Changes to dataset and codebook

First quick data cleaning steps:

-   Date format

-   Remove irrelevant columns

-   Names to lower case

-   Remove farmers that do not want to participate

-   Data types

-   "other" columns

```{r, include = FALSE}

Data <- Data %>%
  
  # Set the date to date format
  mutate(`Submission Date` = as.Date(`Submission Date`, format = "%d-%m-%Y")) %>%
  
  # Remove irrelevant columns
  select(-c(`Display Name`,`Device identifier`,`Instance`,
            `Submitter`, 
            `Form version`)) %>%
  select(-contains("--option--")) %>%
  
  # All column names to lowercase
  rename_all(funs(tolower)) %>%
  
  # Rename option variables
  rename_all( funs(gsub("--other--", "_other2", ., perl=T))) %>%

  # All variables to lowercase
  mutate_all(tolower) %>%
  
  # Remove to farmers that didn't participate
  mutate(ic_informed_consent = na.locf(ic_informed_consent, na.rm = FALSE)) %>%
  filter(ic_informed_consent == "accepted to participate")  %>%
  
  
  # Numerical columns to numeric data type
  mutate_at(vars(numerical_columns), funs(as.numeric)) %>%
    
    #General case
    mutate(f_maize_harvest_num = as.numeric(f_maize_harvest_num)) %>%
    mutate(f_soybean_harvest_num = as.numeric(f_soybean_harvest_num)) %>%
    ## In many cases, the crop has been added to this variable name. Variable will be f_[CROP]_harvest_num. See example below for a cocoa case.
    #mutate(f_cocoa_harvest_num = as.numeric(f_cocoa_harvest_num)) %>% 
  
  # Remove all "other" option text ("other, please specify")
  # mutate_each(funs(str_remove(., "other, please specify"))) %>%
  mutate_if(is.character, funs(gsub("other, please specify", NA,.))) %>% 
  mutate_if(is.character, funs(gsub("\\|$","",.))) %>% 
  
  # Remove trailing spaces
  mutate_if(is.character, str_trim) %>% 
  
  # Remove punctuation and special characters - EXCEPT for "|"
  mutate_if(is.character, funs(gsub("[^\\|[:^punct:]]", "", ., perl=T))) 

```

Adjust the **farm sizes** to acres.

```{r}
# First check what are the unit measurements reported in this case.
table(Data$f_unit_land)
table(Data$f_unit_land_other2)
```

```{r, include = FALSE}
# Mutate the different units to acres.We need a farm size in acres for the total farm size, focus crop, other main crop 1 and othermaincrop 2.
Data <- Data %>%
      unite("f_unit_land", c(f_unit_land, f_unit_land_other2), 
            na.rm = TRUE, remove = FALSE, sep=" ") %>%
    mutate(f_size_acre = ifelse(f_unit_land == "hectares", f_size*2.471, f_size)) %>%
    mutate(f_size_hectare = f_size_acre / 2.471) %>%

    mutate(f_maize_size_acre = ifelse(f_unit_land == "hectares", f_maize_crop_size*2.471, f_maize_crop_size)) %>%
    mutate(f_soybean_size_acre = ifelse(f_unit_land == "hectares", f_soybean_crop_size*2.471, f_soybean_crop_size)) %>%
    mutate(f_maize_crop_size_hectare = f_maize_size_acre / 2.471) %>%
  mutate(f_soybean_crop_size_hectare = f_soybean_size_acre / 2.471) %>%

    mutate(f_size_othermaincrop_1_acre = ifelse(f_unit_land == "hectares",f_size_othermaincrop_1*2.471,f_size_othermaincrop_1))%>%
    mutate(f_size_othermaincrop_1_hectare = f_size_othermaincrop_1_acre / 2.471) %>%

    mutate(f_size_othermaincrop_2_acre = ifelse(f_unit_land == "hectares", f_size_othermaincrop_2*2.471, f_size_othermaincrop_2))%>%
    mutate(f_size_othermaincrop_2_hectare = f_size_othermaincrop_2_acre / 2.471) %>%

  # Extend farm size to determine productivity
    mutate(f_maize_size_acre = na.locf(f_maize_size_acre, na.rm = FALSE),
           f_soybean_size_acre = na.locf(f_soybean_size_acre, na.rm = FALSE))
```

Mutate the birthyear variables to **age.** Check whether they are included in this case or not.

```{r, include = FALSE}
Data <- Data %>%
  mutate(cal_hh_farmer_age = 2022 - hh_farmer_birthyear,
           cal_hh_head_age = 2022-hh_head_birthyear,
           cal_hh_member_birthyear = 2022-hh_member_birthyear) #update to current year, check whether applicable, not always included.
```

### Context specific adjustments

Check for obvious outliers first by running the full code except for running the outlier function below. Download the productivity_check.xlsx. file that is created at the end of the script. Use the filter options and arrange columns from high to low, low to high, etc. to detect outliers manually. Also use the intake form! Highlight the cells you have questions about or that are obvious outliers. Consult the data collection supervisors to make adjustments. The changes in the data can be made in the code block below.

Note that you should keep the variable "submitter" for the time being so we can trace back which enumerator has entried that data. This variable is normally deleted in the script above (cmd+F "submitter"). Make sure you delete this variable in the end when sharing the data.

```{r, include = FALSE}
# Soybean adjustments 
Data <- Data %>%
  # Total in kg instead of number of buckets   
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 3000 & identifier == "atw3nc9qqh21",
                                       60, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 2000 & identifier == "atw3nc9qqh21",
                                       40, f_soybean_quant_sold)) %>%
  
  #Row where quantity sold and produced had wrong measurement unit, revenue instead of price, price also wrong
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 25000 & 
                                         identifier == "438wbd018nkk",2500,f_soybean_quant_sold )) %>%
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 50 & 
                                         identifier == "438wbd018nkk",2500,f_soybean_quant_prod )) %>% 
  mutate(f_soybean_price = ifelse(f_soybean_price == 25000, 10, f_soybean_price)) %>%
  
  # Revenue instead of quantity sold
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 25000 & 
                                         identifier == "bf3t4uh7fbc5",2500,f_soybean_quant_sold )) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 1750 & 
                                         identifier == "88j035k4kqu1",35,f_soybean_quant_sold )) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 10000 & 
                                         identifier == "fj0x0ytj5q3s",1000,f_soybean_quant_sold )) %>% 
  
  # For these rows, it is a combination of wrong measurement unit and total revenue instead of quantity sold
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 4400 & 
                                         identifier == "b9yms95kxdea",550,f_soybean_quant_sold )) %>%
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 11 & 
                                         identifier =="b9yms95kxdea", 550, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 4400 & 
                                         identifier == "12jxdvmw7xw0",550,f_soybean_quant_sold )) %>%
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 11 & 
                                         identifier =="12jxdvmw7xw0", 550, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 4000 & 
                                         identifier == "7gmh76ggqg6d",550,f_soybean_quant_sold )) %>%
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 10 & 
                                         identifier =="7gmh76ggqg6d", 500, f_soybean_quant_prod)) %>%
  # quantity produced has wrong measurement unit, it is 20 * 50kg bags 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 20 & 
                                         identifier == "fj0x0ytj5q3s", 1000, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 20 & 
                                         identifier == "0r496yaaqnvu", 1000, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 20 & 
                                         identifier == "0x1yy5ds6rqc", 1000, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 22 & 
                                         identifier == "pyb854wjm21s", 1100, f_soybean_quant_prod)) %>%
 
  # Large prod - sold, because prod is on 50kg bags and sold in kg --> change sold to 50kg bags 
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 40 & 
                                         identifier == "wrjjdn3bejvp",2000,f_soybean_quant_sold )) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 28 & 
                                         identifier == "6mr96920wx3w",1400,f_soybean_quant_sold )) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 26 & 
                                         identifier == "p9117snmn0ue",1300,f_soybean_quant_sold )) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 25 & 
                                         identifier == "avemm6v2cetw",1250,f_soybean_quant_sold )) %>%
  
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 19 & identifier == "r7tf0u088avy",
                                     950,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 19 & identifier == "r7tf0u088avy",
                                     950,f_soybean_quant_sold)) %>%
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 25 & identifier == "hftk0rrqwhbv",
                                     1250,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 12500 & identifier == "hftk0rrqwhbv",
                                     1250,f_soybean_quant_sold)) %>%
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 200 & identifier == "yy7p2hcrrmg9",
                                     10000,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 180 & identifier == "yy7p2hcrrmg9",
                                     9000,f_soybean_quant_sold)) %>%
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 100 & identifier == "52as2pmaqhux",
                                     5000,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 95 & identifier == "52as2pmaqhux",
                                     4750,f_soybean_quant_sold)) %>%
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 50 & identifier == "ugfsch6d7bba",
                                     2500,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 45 & identifier == "ugfsch6d7bba",
                                     2250,f_soybean_quant_sold)) %>%
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 40 & identifier == "7wa8xdrc478b",
                                     2000,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 40 & identifier == "7wa8xdrc478b",
                                     2000,f_soybean_quant_sold)) %>%
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 40 & identifier == "4ak5ng9fe2vy",
                                     2000,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 30 & identifier == "4ak5ng9fe2vy",
                                     1500,f_soybean_quant_sold)) %>%
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 45 & identifier == "hxyn7sbc88p6",
                                     2250,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 30 & identifier == "hxyn7sbc88p6",
                                     1500,f_soybean_quant_sold)) %>%
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 25 & identifier == "k71f86xpn7hw",
                                     1250,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 23 & identifier == "k71f86xpn7hw",
                                     1150,f_soybean_quant_sold)) %>%
  
   # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 15 & identifier == "d829x72kars7",
                                     750,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 15 & identifier == "d829x72kars7",
                                     750,f_soybean_quant_sold)) %>%
  
  # indicated kg, but must be 50kg bags given the value for the unit price 
  mutate(f_soybean_quant_prod = ifelse(f_soybean_quant_prod == 10 & identifier == "x2rdauh8btn9",
                                     500,f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(f_soybean_quant_sold == 10 & identifier == "x2rdauh8btn9",
                                     500,f_soybean_quant_sold)) %>%
  
  # Adjust prices: total revenue was given instead of unit price 
  mutate(f_soybean_price = ifelse(f_soybean_price == 90000, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 47500, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 22500, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 20000, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 15000, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 12500, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 11500, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 10000, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 9500, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 7500, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 5000, 10, f_soybean_price)) %>%

 # Adjust other outlier prices to the median value 
  mutate(f_soybean_price = ifelse(f_soybean_price == 550, 10, f_soybean_price)) %>%
  mutate(f_soybean_price = ifelse(f_soybean_price == 200, 10, f_soybean_price)) %>%

# For last 4 farmers, number produced and sold is put to zero (no sense making possible)
  mutate(f_soybean_quant_prod = ifelse(identifier == "p3axhq0u5sjr",0, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(identifier == "p3axhq0u5sjr",0, f_soybean_quant_sold)) %>%
  
  mutate(f_soybean_quant_prod = ifelse(identifier == "34rk90ka0fnr",0, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(identifier == "34rk90ka0fnr",0, f_soybean_quant_sold)) %>%
  
  mutate(f_soybean_quant_prod = ifelse(identifier == "5rtwcpj1q11j",0, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(identifier == "5rtwcpj1q11j",0, f_soybean_quant_sold)) %>%
  
  mutate(f_soybean_quant_prod = ifelse(identifier == "355wxdv02fkm",0, f_soybean_quant_prod)) %>%
  mutate(f_soybean_quant_sold = ifelse(identifier == "355wxdv02fkm",0, f_soybean_quant_sold)) 

```

```{r, include = FALSE}
# Context specific adjustments for maize 
Data <- Data %>%
  # Measurement unit should have been 50kg bags instead of kg 
  mutate(f_maize_quant_prod = ifelse(f_maize_quant_prod == 5000 & identifier == "mv10gcjtam8v",
                                     100,f_maize_quant_prod)) %>%
  mutate(f_maize_quant_sold = ifelse(f_maize_quant_sold == 4000 & identifier == "mv10gcjtam8v",
                                     80,f_maize_quant_sold)) %>%
  mutate(f_maize_quant_prod = ifelse(f_maize_quant_prod == 3000 & identifier == "47h880scj7yh",
                                     60,f_maize_quant_prod)) %>%
  mutate(f_maize_quant_prod = ifelse(f_maize_quant_prod == 1250 & identifier == "cskapqyyvq4s",
                                     25,f_maize_quant_prod)) %>%
  mutate(f_maize_quant_sold = ifelse(f_maize_quant_sold == 500 & identifier == "cskapqyyvq4s",
                                     10,f_maize_quant_sold)) %>%
  mutate(f_maize_quant_prod = ifelse(f_maize_quant_prod == 4500 & identifier == "1hgxnutqeb47",
                                     90,f_maize_quant_prod)) %>%
  mutate(f_maize_quant_sold = ifelse(f_maize_quant_sold == 2500 & identifier == "1hgxnutqeb47",
                                     50,f_maize_quant_sold)) %>%
  mutate(f_maize_quant_prod = ifelse(f_maize_quant_prod == 2000 & identifier == "xsh2c15quwr3",
                                     40,f_maize_quant_prod)) %>%
  mutate(f_maize_quant_sold = ifelse(f_maize_quant_sold == 650 & identifier == "xsh2c15quwr3",
                                     13,f_maize_quant_sold)) %>%
  mutate(f_maize_quant_prod = ifelse(f_maize_quant_prod == 1000 & identifier == "4fgktt3htj5j",
                                     20,f_maize_quant_prod)) %>%
  mutate(f_maize_quant_prod = ifelse(f_maize_quant_prod == 2250 & identifier == "j7tcjbf1an2u",
                                     45,f_maize_quant_prod)) %>%
  mutate(f_maize_quant_sold = ifelse(f_maize_quant_sold == 1050 & identifier == "j7tcjbf1an2u",
                                     21,f_maize_quant_sold)) %>%
  mutate(f_maize_quant_prod = ifelse(f_maize_quant_prod == 2000 & identifier == "5tsy9eggphq0",
                                     40,f_maize_quant_prod)) %>%
  mutate(f_maize_quant_sold = ifelse(f_maize_quant_sold == 2000 & identifier == "5tsy9eggphq0",
                                     40,f_maize_quant_sold)) %>%
  mutate(f_maize_quant_prod = ifelse(f_maize_quant_prod == 400 & identifier == "5q43tc2muppd",
                                     8,f_maize_quant_prod)) %>%
  mutate(f_maize_quant_sold = ifelse(f_maize_quant_sold == 2500 & identifier == "9kvw8r0xvt0r",
                                     50,f_maize_quant_sold)) %>%
  
  
  # Total revenue instead of quantity 
  mutate(f_maize_quant_sold = ifelse(f_maize_quant_sold == 1050 & identifier == "j8ujx88vd1hs",
                                     300, f_maize_quant_sold)) %>%
  
  # Wrong unit of measurement 
  mutate(f_maize_quant_sold = ifelse(f_maize_quant_sold == 150 & identifier == "m0jnwxe92jth",
                                     3, f_maize_quant_sold)) %>%
  
  # Wrong prices 
  mutate(f_maize_price = ifelse(f_maize_price == 99991, NA, f_maize_price)) %>%
  mutate(f_maize_price = ifelse(f_maize_price == 9988, NA, f_maize_price)) %>%
  mutate(f_maize_price = ifelse(f_maize_price == 125, 3, f_maize_price)) %>% # Outlier to median value
  # Price of 0, but value for produce sold. So put it to the median value 
  mutate(f_maize_price = ifelse(f_maize_price == 0 & identifier == "5tsy9eggphq0", 3, f_maize_price))

```

Handle outliers. Keep in mind that you do not run the outlier function before productivity check!

```{r, include = FALSE}

# OUTLIERS:
# If names of variables have changed in the survey_questions file, run this code again:
#Identify numerical columns again because of change in names above
numerical_columns <- survey_questions %>%
filter(type == "number") %>%
select("variable") %>% pull()

Data <- Data %>%
    # Do not run this function when you still need to do the productivity check!!!! See explanation above.
    mutate_at(vars(numerical_columns), funs(outlier_detection)) %>%
    
    # All variables that are 9999/"i don't know" or 9998/"i prefer not to say" are set to NA
    mutate_if(is.numeric, list(~na_if(., 9999))) %>%
    mutate_if(is.numeric, list(~na_if(., 9998))) %>%
    mutate_if(is.numeric, list(~na_if(., 9997))) %>%
    mutate_if(is.character, list(~na_if(., "i don't know"))) %>%
    mutate_if(is.character, list(~na_if(., "i prefer not to say"))) 
```

### Other variables

Identify the "other" variables, and combine the values with their parent. Then the "other" variables are removed.

```{r, include = FALSE}
variables_other <- Data %>% 
  select(ends_with("_other"), ends_with("_other2")) %>% 
  names() 

for(other in variables_other){
  
  if(any(names(Data) %in% gsub("_other$|_other2$", "", other))){
    
    # Fuzzy match? - many spelling mistakes in "other" questions
    
    # Combine "other" variables with their parents
    Data <- Data %>%
      unite(!!gsub("_other$|_other2$", "", other), 
            c(gsub("_other$|_other2$", "", other), all_of(other)), 
            sep="|", remove=FALSE, na.rm=TRUE) %>%
      select(-other)
  }
}
```

### Some statistics

```{r, include = FALSE}
# Number of participants who gave informed consent 
nr_participants_ic <- length(unique(Data$identifier))

# NUMBER OF SEASONS
number_of_seasons_maize <- max(Data$f_maize_harvest_num, na.rm=TRUE)
number_of_seasons_soybean <- max(Data$f_soybean_harvest_num, na.rm=TRUE)

```

# Actual income calculation

### 1) Transform unit measurements 

Each unit measurement variables needs to be aligned. We transform every variable to kg. 

First check what are the unit measurement reported in this case. Use the code below, or check the Lumen dashboard. 
```{r}
table(Data$f_maize_measurement_prod)
table(Data$f_maize_measurement_sold)
table(Data$f_maize_measurement_lost)
table(Data$f_maize_own_consumption_measurement)
```

To do so, we extract the numerical values from the measurement units for quantity produced, sold, consumed and lost. Always check by hand whether this is going well. We extract the numbers from the measurement units to calculate total quantities. If there are other measurement units, not related to kg, put a value for those in the variable: cal_focus_measurement_prod

```{r, include = FALSE}
Data <- Data %>%
##Measurement unit for production maize
  mutate(cal_maize_measurement_prod := ifelse(
      grepl("[[:digit:]]", f_maize_measurement_prod), 
      extract_numeric(f_maize_measurement_prod), 
      ifelse(f_maize_measurement_prod %in% c("KG","kg","kilo","kgs","kilogram", "kilograms kg"), 1, 0))) %>%
  mutate(cal_maize_measurement_prod = ifelse(f_maize_measurement_prod == "i dont know", NA, cal_maize_measurement_prod)) %>%

##Measurement unit for sales maize
  mutate(cal_maize_measurement_sold := ifelse(
      grepl("[[:digit:]]", f_maize_measurement_sold), 
      extract_numeric(f_maize_measurement_sold), 
      ifelse(f_maize_measurement_sold %in% c("KG","kg","kilo","kgs","kilogram", "kilograms kg"), 1, 0))) %>%  
  mutate(cal_maize_measurement_sold = ifelse(f_maize_measurement_sold 
                                             %in% c("home consumption","i dont know", "sold nothing its for
                                             home consumption","she didnt sell any", "00"), 
                                             NA, cal_maize_measurement_sold)) %>%
  mutate(cal_maize_measurement_sold = ifelse(f_maize_measurement_sold == 
                                               "50 kgs bag|sold 2 backets4 make a bucket", 
                                             50, cal_maize_measurement_sold)) %>%

# measurement unit for lost
  mutate(cal_maize_lost_measurement := ifelse(
    grepl("[[:digit:]]", f_maize_measurement_lost), 
    extract_numeric(f_maize_measurement_lost), 
    ifelse(f_maize_measurement_lost %in% c("KG","kg","kilo","kgs","kilogram", "kilograms kg"), 1, 0))) %>% 
  mutate(cal_maize_lost_measurement = ifelse(f_maize_measurement_lost == "no", NA, cal_maize_lost_measurement)) %>%

      
#measurement unit for own consumption
##!! REMOVE IF NOT APPLICABLE
  mutate(cal_maize_measurement_own_consumption := ifelse(
    grepl("[[:digit:]]", f_maize_own_consumption_measurement), 
    extract_numeric(f_maize_own_consumption_measurement), 
    ifelse(f_maize_own_consumption_measurement %in% c("KG","kg","kilo","kgs","kilogram", "kilograms kg"), 1, 0)))  %>%
  mutate(cal_maize_measurement_own_consumption = ifelse(f_maize_own_consumption_measurement == "i dont know", NA, cal_maize_measurement_own_consumption))

```

Again, for soybean. 

```{r}
table(Data$f_soybean_measurement_prod)
table(Data$f_soybean_measurement_sold)
table(Data$f_soybean_measurement_lost)

```

```{r, include = FALSE}

Data <- Data %>%
##Measurement unit for production soybean 
  mutate(cal_soybean_measurement_prod := ifelse(
      grepl("[[:digit:]]", f_soybean_measurement_prod), 
      extract_numeric(f_soybean_measurement_prod), 
      ifelse(f_soybean_measurement_prod %in% c("KG","kg","kilo","kgs","kilogram", "kilograms kg"), 1, 0))) %>%
  mutate(cal_soybean_measurement_prod = ifelse(f_soybean_measurement_prod == "i dont know", NA, cal_soybean_measurement_prod)) %>%
  mutate(cal_soybean_measurement_prod = ifelse(f_soybean_measurement_prod == "60 bags of 50kg", 50, cal_soybean_measurement_prod)) %>%
  mutate(cal_soybean_measurement_prod = ifelse(f_soybean_measurement_prod == "tons", 1000, cal_soybean_measurement_prod)) %>%

##Measurement unit for sales soybean
  mutate(cal_soybean_measurement_sold := ifelse(
      grepl("[[:digit:]]", f_soybean_measurement_sold), 
      extract_numeric(f_soybean_measurement_sold), 
      ifelse(f_soybean_measurement_sold %in% c("KG","kg","kilo","kgs","kilogram", "kilograms kg"), 1, 0))) %>%  
  mutate(cal_soybean_measurement_sold = ifelse(f_soybean_measurement_sold %in% c("home consumption", "i dont know", 
                                                                             "consumption"), NA, cal_soybean_measurement_sold)) %>%
  mutate(cal_soybean_measurement_sold = ifelse(f_soybean_measurement_sold == "20 bags 50kg each", 50, cal_soybean_measurement_sold)) %>%
  mutate(cal_soybean_measurement_sold = ifelse(f_soybean_measurement_sold == "40bags of 50kg", 50, cal_soybean_measurement_sold)) %>%
  mutate(cal_soybean_measurement_sold = ifelse(f_soybean_measurement_sold == "liters", 1, cal_soybean_measurement_sold)) %>%
  mutate(cal_soybean_measurement_sold = ifelse(f_soybean_measurement_sold == "tons", 1000, cal_soybean_measurement_sold)) %>%
  
# measurement unit for lost
  mutate(cal_soybean_lost_measurement := ifelse(
    grepl("[[:digit:]]", f_soybean_measurement_lost), 
    extract_numeric(f_soybean_measurement_lost), 
    ifelse(f_soybean_measurement_lost %in% c("KG","kg","kilo","kgs","kilogram", "kilograms kg"), 1, 0))) %>% 
  mutate(cal_soybean_lost_measurement = ifelse(f_soybean_measurement_lost == "8bags of 50kg", 50, cal_soybean_lost_measurement))

```

### 2) Quantities produced, sold, lost and own consumption

Now that the unit measurements are transformed, the quantities produced, sold, lost and own consumption can be calculated. 

```{r, include = FALSE}
##Calculate the quantities maize
Data <- Data %>%
  mutate(cal_maize_quant_prod_kg = f_maize_quant_prod * cal_maize_measurement_prod) %>%
  mutate(cal_maize_quant_sold_kg = f_maize_quant_sold * cal_maize_measurement_sold) %>%
  mutate(cal_maize_quant_lost_kg = f_maize_quant_lost * cal_maize_lost_measurement) %>%
  mutate(cal_maize_quant_own_consumption_kg = f_maize_own_consumption * cal_maize_measurement_own_consumption) %>%
  
  # also calculate the uit price 
  mutate(cal_maize_price= f_maize_price)  
```

Check whether the calculation went well. We make a subset of the data with relevant variables. Click on the dataset to sort the columns to detect strange numbers and solve if necessary. 
```{r, include = FALSE}

quantities_produced_subset <- Data %>% select(f_maize_measurement_prod, cal_maize_measurement_prod, f_maize_quant_prod, cal_maize_quant_prod_kg)
quantities_sold_subset <- Data %>% select(f_maize_measurement_sold, cal_maize_measurement_sold, f_maize_quant_sold, cal_maize_quant_sold_kg)
quantities_lost_subset <- Data %>% select(f_maize_measurement_lost, cal_maize_lost_measurement, f_maize_quant_lost, cal_maize_quant_lost_kg)
quantities_own_consumption_subset <- Data %>% select(f_maize_own_consumption_measurement, cal_maize_measurement_own_consumption, f_maize_own_consumption, cal_maize_quant_own_consumption_kg)

```

Also for soybeans
```{r, include = FALSE}
##Calculate the quantities maize
Data <- Data %>%
  mutate(cal_soybean_quant_prod_kg = f_soybean_quant_prod * cal_soybean_measurement_prod) %>%
  mutate(cal_soybean_quant_sold_kg = f_soybean_quant_sold * cal_soybean_measurement_sold) %>%
  mutate(cal_soybean_quant_lost_kg = f_soybean_quant_lost * cal_soybean_lost_measurement) %>%

  # also calculate the uit price 
  mutate(cal_soybean_price= f_soybean_price)  
```

Check whether the calculation went well. We make a subset of the data with relevant variables. Click on the dataset to sort the columns to detect strange numbers and solve if necessary. 
```{r, include = FALSE}
quantities_produced_subset <- Data %>% select(f_soybean_measurement_prod, cal_soybean_measurement_prod, f_soybean_quant_prod, cal_soybean_quant_prod_kg)
quantities_sold_subset <- Data %>% select(f_soybean_measurement_sold, cal_soybean_measurement_sold, f_soybean_quant_sold, cal_soybean_quant_sold_kg)
quantities_lost_subset <- Data %>% select(f_soybean_measurement_lost, cal_soybean_lost_measurement, f_soybean_quant_lost, cal_soybean_quant_lost_kg)
```

### 3) Focus crop revenue 

```{r, include = FALSE}
Data <- Data %>%
  mutate(cal_maize_revenue = cal_maize_quant_sold_kg * cal_maize_price) %>%
  mutate(cal_soybean_revenue = cal_soybean_quant_sold_kg * cal_soybean_price)
   
##X) STANDARD APPROACH Inbetween, adjust for repeated question groups (IF APPLICABLE)  ----  
     ##Adress values for those that have multiple seasons

# FOR MAIZE
Data <- Data %>%
  #Identify duplicates
  group_by(identifier, f_maize_rev_timeperiod) %>% mutate(count_dup = n()) %>%
  mutate(count_dup = ifelse(is.na(f_maize_rev_timeperiod), NA, count_dup)) %>% #check whether we don't make mistakes here. For some cases farmer enter twice wrongly, in other cases entering same values for 2 seasons is ok.
  #Identify those with multiple seasons
  group_by(identifier, f_maize_rev_timeperiod) %>% mutate(count_seasons = n()) %>%
  mutate(count_seasons = ifelse(is.na(f_maize_rev_timeperiod) | count_seasons > 1, NA, count_seasons)) %>%

#Replace values with 0 for those that entered the data twice 
  mutate(`repeat no` = as.numeric(`repeat no`)) %>%
  mutate(cal_maize_quant_prod_kg = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_maize_quant_prod_kg)) %>%
  mutate(cal_maize_quant_sold_kg = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_maize_quant_sold_kg)) %>%
  mutate(cal_maize_quant_own_consumption_kg = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_maize_quant_own_consumption_kg )) %>%
  mutate(cal_maize_quant_lost_kg = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_maize_quant_lost_kg)) %>%
  mutate(cal_maize_revenue = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_maize_revenue)) %>%

#Sum the quantities for those that entered data for multiple seasons
  group_by(identifier, count_seasons) %>%
  mutate(cal_maize_quant_prod_kg =  sum(cal_maize_quant_prod_kg)) %>%
  mutate(cal_maize_quant_sold_kg =  sum(cal_maize_quant_sold_kg)) %>%
  mutate(cal_maize_quant_own_consumption_kg =  sum(cal_maize_quant_own_consumption_kg)) %>%
  mutate(cal_maize_quant_lost_kg =  sum(cal_maize_quant_lost_kg)) %>%
  mutate(cal_maize_revenue = sum(cal_maize_revenue)) %>%

#Ensure we have 1 row of data for each farmer
  mutate(cal_maize_quant_prod_kg = ifelse(`repeat no` >1 , NA, cal_maize_quant_prod_kg)) %>%
  mutate(cal_maize_quant_sold_kg = ifelse(`repeat no` >1  , NA, cal_maize_quant_sold_kg)) %>%
  mutate(cal_maize_quant_own_consumption_kg = ifelse(`repeat no` >1  , NA, cal_maize_quant_own_consumption_kg )) %>%
  mutate(cal_maize_quant_lost_kg = ifelse(`repeat no` >1 , NA, cal_maize_quant_lost_kg)) %>%
  mutate(cal_maize_revenue = ifelse (`repeat no`>1, NA, cal_maize_revenue)) %>%
  ungroup() %>%
  select(-count_dup, -count_seasons)

# FOR SOYBEAN
Data <- Data %>%
  #Identify duplicates
  group_by(identifier, f_soybean_rev_timeperiod) %>% mutate(count_dup = n()) %>%
  mutate(count_dup = ifelse(is.na(f_soybean_rev_timeperiod), NA, count_dup)) %>% #check whether we don't make mistakes here. For some cases farmer enter twice wrongly, in other cases entering same values for 2 seasons is ok.
  #Identify those with multiple seasons
  group_by(identifier, f_soybean_rev_timeperiod) %>% mutate(count_seasons = n()) %>%
  mutate(count_seasons = ifelse(is.na(f_soybean_rev_timeperiod) | count_seasons > 1, NA, count_seasons)) %>%

#Replace values with 0 for those that entered the data twice 
  mutate(`repeat no` = as.numeric(`repeat no`)) %>%
  mutate(cal_soybean_quant_prod_kg = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_soybean_quant_prod_kg)) %>%
  mutate(cal_soybean_quant_sold_kg = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_soybean_quant_sold_kg)) %>%
  mutate(cal_soybean_quant_lost_kg = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_soybean_quant_lost_kg)) %>%
  mutate(cal_soybean_revenue = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_soybean_revenue)) %>%

#Sum the quantities for those that entered data for multiple seasons
  group_by(identifier, count_seasons) %>%
  mutate(cal_soybean_quant_prod_kg =  sum(cal_soybean_quant_prod_kg)) %>%
  mutate(cal_soybean_quant_sold_kg =  sum(cal_soybean_quant_sold_kg)) %>%
  mutate(cal_soybean_quant_lost_kg =  sum(cal_soybean_quant_lost_kg)) %>%
  mutate(cal_soybean_revenue = sum(cal_soybean_revenue)) %>%

#Ensure we have 1 row of data for each farmer
  mutate(cal_soybean_quant_prod_kg = ifelse(`repeat no` >1 , NA, cal_soybean_quant_prod_kg)) %>%
  mutate(cal_soybean_quant_sold_kg = ifelse(`repeat no` >1  , NA, cal_soybean_quant_sold_kg)) %>%
  mutate(cal_soybean_quant_lost_kg = ifelse(`repeat no` >1 , NA, cal_soybean_quant_lost_kg)) %>%
  mutate(cal_soybean_revenue = ifelse (`repeat no`>1, NA, cal_soybean_revenue)) %>%
  ungroup() %>%
  select(-count_dup, -count_seasons)
  
##Calculate revenue from focus crop
Data <- Data %>%
  mutate(cal_maize_revenue= ifelse(is.na(cal_maize_revenue), 0, cal_maize_revenue)) %>%
  mutate(cal_soybean_revenue= ifelse(is.na(cal_soybean_revenue), 0, cal_soybean_revenue))

```

### 4) Productivity 

```{r, include = FALSE}
Data <- Data %>%
  mutate(cal_maize_productivity_acre = cal_maize_quant_prod_kg/f_maize_size_acre)  %>%
  mutate(cal_soybean_productivity_acre = cal_soybean_quant_prod_kg/f_soybean_size_acre)

```

### 5) Labour costs 

```{r, include = FALSE}
survey_questions <- survey_questions %>%
    mutate(variable = ifelse(variable == "f_labour_compostprep_paymentpertimeframe_1_1","f_labour_compostprep_paymentperday",variable))
  
#Get the labour types 
labour_types <- Data %>% 
  cSplit("f_crop_labour_types", "|") %>% 
  select(starts_with("f_crop_labour_types")) %>% 
  gather(key, value) %>% filter(!is.na(value)) %>% 
  select(value) %>% unique() %>% pull()

survey_labour_types <- substr(gsub("\\s|-", "", labour_types), 1, 5)

##!!!!!!Adjust labour_options per case. Check in the survey which activities are surveyed.
## Sometimes, a combination of a labour activity and timeperiod is not selected and therefore not appearing.
# For example, f_labour_compostprep_nrhours -> there can be a case that no one that is hiring labour for compost preparation is registering this wage per hour.
# This piece of code can give some error, handle with care and check whether there are errors -> solve them. There is not one solution fits all.
labour_options <- c("landprep", "nurserymaint", "cropmaint", "agrochemicalapp",
                    "irrigation", "fertilizerapp", "compostprep", "harvesting", 
                    "postharvest", "otheractivity")

Data <- Data %>%
  mutate(f_labour_cropmaint_paymentperactivity = 0,
         f_labour_compostprep_paymentperday = 0,
         f_labour_nurserymaint_paymentperactivity = 0)

#Calculation of labour costs
for(j in survey_labour_types){
  
  if(any(startsWith(labour_options, j))){
    
    var_name <- paste0("_labour_", labour_options[startsWith(labour_options, j)])
    
    Data <- Data %>% 
      mutate_at(vars(contains("_othertype")), as.numeric) %>%
      mutate_at(vars(contains("_othercosts")), as.numeric) %>%     
      
      #Calculate total number of hours for those that reported per hour
      mutate("cal{var_name}_nrhours" := Data %>% 
               select(!!sym(paste0("f", var_name, "_nrhours")),
                      !!sym(paste0("f", var_name, "_nrdays"))) %>%
               apply(.,1,prod,na.rm=FALSE)) %>%
      mutate("f{var_name}_nrdays" := ifelse(!is.na(!!sym(paste0("f", var_name, "_nrhours"))), NA,
                                            !!sym(paste0("f", var_name, "_nrdays"))))  
  }
}
  
for(j in survey_labour_types){
  
  if(any(startsWith(labour_options, j))){
    var_name <- paste0("_labour_", labour_options[startsWith(labour_options, j)])
    Data <- Data %>% 
      ##Calculate wage costs for those that paid per hour
      mutate("cal{var_name}_hour_costs" := Data %>% 
               select(!!sym(paste0("cal", var_name, "_nrhours")),
                      !!sym(paste0("f", var_name, "_paymentperhour")),
                      !!sym(paste0("f", var_name, "_nrhiredpeople")),) %>%
               apply(.,1,prod)) %>%
      
      ##Calculate wage costs for those that paid per day
      mutate("cal{var_name}_day_costs" := Data %>% 
               select(!!sym(paste0("f", var_name, "_nrdays")),
                      !!sym(paste0("f", var_name, "_paymentperday")),
                      !!sym(paste0("f", var_name, "_nrhiredpeople")),) %>%
               apply(.,1,prod)) %>%
      
      ##Calculate wage costs for those that paid per months
      mutate("cal{var_name}_month_costs" := Data %>% 
               select(!!sym(paste0("f", var_name, "_nrmonths")),
                      !!sym(paste0("f", var_name, "_paymentpermonth")),
                      !!sym(paste0("f", var_name, "_nrhiredpeople")),) %>%
               apply(.,1,prod)) %>%
      
      ##Calculate wage costs for those that paid per activity
      mutate("cal{var_name}_activity_costs" := Data %>% 
               select(!!sym(paste0("f", var_name, "_paymentperactivity")),
                      !!sym(paste0("f", var_name, "_nrhiredpeople")),) %>%
               apply(.,1,prod)) %>%
    
      unite(!!paste0("cal", var_name, "_part_1_total_cost"),
            !!sym(paste0("cal", var_name, "_day_costs")):!!sym(paste0("cal", var_name, "_activity_costs")), 
            sep="|", remove=FALSE, na.rm=FALSE) %>%  
      mutate("cal{var_name}_part_1_total_cost" := extract_numeric( !!sym(paste0("cal", var_name, "_part_1_total_cost")))) %>%
      
      
    #Calculate total cost for those that  reported wage using "other method"
    mutate("f{var_name}_rememberwage_othercosts" := as.numeric(
      !!sym(paste0("f", var_name, "_rememberwage_othercosts")))) %>%
 
    mutate("cal{var_name}_part_2_total_cost" := Data %>% 
             select(!!sym(paste0("f", var_name, "_rememberwage_othercosts")),
                    !!sym(paste0("f", var_name, "_nrhiredpeople"))) %>%
             apply(., 1, prod))
    
  }
}
  
#Remove several variables
Data <- Data %>%
  select(-contains("alltimeframes"), 
         -ends_with("hour_costs"),
         -ends_with("day_costs"),
         -ends_with("month_costs"),
         -ends_with("activity_costs"),
         -ends_with("nrhours"),
         -f_labour_cropmaint_paymentperactivity,
             -f_labour_nurserymaint_paymentperactivity) %>%
  
  mutate_at(vars(starts_with("cal_labour") & ends_with("_total_cost")), as.numeric) 

# Combine costs of all types of labour
Data <- Data %>% 
mutate(cal_labour_cost = Data %>%
         select(starts_with("cal_labour") & ends_with("_total_cost")) %>% 
         rowSums(na.rm=TRUE)) 

Data <- Data %>%
select(-contains("part_1_total_cost"),-contains("part_2_total_cost")) 
```


```{r, include = FALSE}
## Inbetween, adjust for repeated questions groups (IF APPLICABLE) ----  
  
##Adress values for those that have multiple seasons
Data <- Data %>%
#Identify duplicates
group_by(identifier, f_crop_labour_timeperiod) %>% mutate(count_dup = n()) %>% #check whether we don't make mistakes here. For some cases farmer enter twice wrongly, in other cases entering same values for 2 seasons is ok.
mutate(count_dup = ifelse(is.na(f_crop_labour_timeperiod), NA, count_dup)) %>%
#Identify those with multiple seasons
group_by(identifier, f_crop_labour_timeperiod) %>% mutate(count_seasons = n()) %>%
mutate(count_seasons = ifelse(is.na(f_crop_labour_timeperiod) | count_seasons > 1, NA, count_seasons)) %>%

#Replace values with 0 for those that entered the data twice
mutate(`repeat no` = as.numeric(`repeat no`)) %>%
mutate(cal_labour_cost = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_labour_cost)) %>%

#Sum the values for those that entered data for multiple seasons
group_by(identifier, count_seasons) %>%
mutate(cal_labour_cost =  sum(cal_labour_cost)) %>%

#Ensure we have 1 row of data for each farmer
mutate(cal_labour_cost = ifelse(`repeat no` >1 , NA, cal_labour_cost)) %>%
ungroup() %>% select(-count_dup, -count_seasons)
```

### 6) Input costs 

```{r, include = FALSE}
Data <- Data %>%
    rename(f_inputs_types = f_inputs_costs_types) %>%
    mutate_at(vars(starts_with("f_inputs_costs")), as.numeric) 
  
Data <- Data %>%
  mutate(cal_inputs_costs = Data %>% 
           select(starts_with("f_inputs_costs")) %>%
           rowSums(na.rm=TRUE)) 
  
Data <- Data %>%
  rename(f_inputs_costs_types = f_inputs_types) 
```

```{r, include = FALSE}
# In between ,adjust for RQG
Data <- Data %>%
  #Identify duplicates
  group_by(identifier, f_inputs_timeperiod) %>% mutate(count_dup = n()) %>%
  mutate(count_dup = ifelse(is.na(f_inputs_timeperiod), NA, count_dup)) %>%
  #Identify those with multiple seasons
  group_by(identifier, f_inputs_timeperiod) %>% mutate(count_seasons = n()) %>%
  mutate(count_seasons = ifelse(is.na(f_inputs_timeperiod) | count_seasons > 1, NA, count_seasons)) %>%
  
  #Replace values with 0 for those that entered the data twice
  mutate(`repeat no` = as.numeric(`repeat no`)) %>%
  mutate(cal_inputs_costs = ifelse(`repeat no` >1  & count_dup > 1, 0, cal_inputs_costs)) %>%
  
  #Sum the values for those that entered data for multiple seasons
  group_by(identifier, count_seasons) %>%
  mutate(cal_inputs_costs =  sum(cal_inputs_costs)) %>%
  
  #Ensure we have 1 row of data for each farmer
  mutate(cal_inputs_costs = ifelse(`repeat no` >1 , NA, cal_inputs_costs)) %>%
  ungroup() %>%
  select(-count_dup, -count_seasons)
```

```{r}
Data$cal_labour_cost <- Data$cal_labour_cost %>% replace(is.na(.), 0)
Data$cal_inputs_costs <- Data$cal_inputs_costs %>% replace(is.na(.), 0)
Data$f_transport <- Data$f_transport %>% replace(is.na(.), 0)

```

### 7) Focus crop cost

```{r, include=FALSE}
Data <- Data %>%
    mutate(cal_focus_cost = cal_labour_cost + cal_inputs_costs + f_transport) 

```

### 8) Net-income focus crop 

```{r, include=FALSE}
Data <- Data %>%
  mutate(cal_focus_income = cal_maize_revenue + cal_soybean_revenue - cal_focus_cost)
```

### 9) Net-income other crops 

```{r, include = FALSE}
Data <- Data %>%
  mutate(cal_othermaincrop_1_cost = Data %>% 
           select(starts_with("f_othermaincrop_1_cost")) %>%
           apply(.,1,sum, na.rm=TRUE)) %>%
  mutate(cal_othermaincrop_2_cost = Data %>% 
           select(starts_with("f_othermaincrop_2_cost")) %>%
           apply(.,1,sum, na.rm=TRUE)) %>%
  mutate(cal_othermaincrop_1_inc_sold = ifelse(is.na(f_othermaincrop_1_inc_sold), 0, f_othermaincrop_1_inc_sold)) %>%
  mutate(cal_othermaincrop_2_inc_sold = ifelse(is.na(f_othermaincrop_2_inc_sold), 0, f_othermaincrop_2_inc_sold))  %>%
  mutate(cal_othermaincrop_income = cal_othermaincrop_1_inc_sold - cal_othermaincrop_1_cost + cal_othermaincrop_2_inc_sold - cal_othermaincrop_2_cost  ) %>%
  mutate(cal_other_crop_income = ifelse(is.na(f_other_crop_income), 0, f_other_crop_income)) %>%
  mutate(cal_other_crop_income = cal_othermaincrop_income + cal_other_crop_income) %>%
  select(-cal_othermaincrop_income)
```

### 10) Net-income livestock

```{r, include = FALSE}
Data <- Data %>%
    
    mutate(cal_livestock_revenue = Data %>% 
             select(contains("f_livestock_income"), -contains("type")) %>%
             rowSums(na.rm=TRUE)) %>%
    mutate(cal_livestock_revenue= ifelse(is.na(cal_livestock_revenue), 0, cal_livestock_revenue)) %>%
    
    #Input costs
    mutate(cal_livestock_inputs_cost = Data %>% 
             select(f_livestock_costs_fodderwater, 
                    f_livestock_costs_medics) %>%
             rowSums(na.rm=TRUE)) %>%
    mutate(cal_livestock_inputs_cost= ifelse(is.na(cal_livestock_inputs_cost), 0, cal_livestock_inputs_cost)) 

    #Labour cost
    Data <- Data %>%
      mutate(cal_livestock_labour_cost = Data %>% 
               select(f_livestock_nr_hired_labourers, 
                      f_livestock_days_hiredlabour, 
                      f_livestock_wages_hiredlabour) %>%
               apply(., 1, prod, na.rm=FALSE)) %>%
      mutate(cal_livestock_labour_cost= ifelse(is.na(cal_livestock_labour_cost), 0, cal_livestock_labour_cost)) 

    # total cost
    Data <- Data %>%
      mutate(cal_livestock_cost = Data %>% 
               select(cal_livestock_inputs_cost,
                      cal_livestock_labour_cost) %>%
               rowSums(na.rm=FALSE)) %>%
      
    #net income
    mutate(cal_livestock_income = cal_livestock_revenue - cal_livestock_cost)

```

### 11) Other farm costs 
```{r, include = FALSE}
# EQUIPMENT
Data <- Data %>%
  mutate(cal_equipment_costs = Data %>% 
           select(f_nonmech_equip_costs, f_mech_equip_costs,f_materials_other_costs) %>% 
           apply(.,1,sum, na.rm=TRUE)) %>%

# GENERAL ON FARM COSTS
  mutate(cal_farm_other_costs = Data %>% 
           select(f_costs_land,
                  hh_loan_one_other_costs_interest,
                  hh_loan_one_agri_costs_interest,
                  hh_loan_multiple_largest_costs_interest,
                  hh_loan_multiple_agri_costs_interest) %>%
             apply(., 1, sum, na.rm=TRUE)) 
    
```

### 12) Off-farm labour income 

```{r, include = FALSE}
Data <- Data %>%
    mutate(cal_off_farm_labour_income = Data %>% 
             select(f_nonfarm_enterpr_1_profit,
                    f_nonfarm_enterpr_2_profit,
                    f_nonfarm_enterpr_3_profit,
                    f_income_offfarmlabour_wage) %>%
             apply(., 1, sum, na.rm=TRUE))
```

### 13) Off-farm non-labour income 

```{r, include = FALSE}
Data <- Data %>% 
      mutate(cal_offfarm_non_labour_income = Data %>%
               select(starts_with("f_income_other_"), -contains("_type")) %>% 
               apply(.,1,sum, na.rm=TRUE)) 
```

### 14) Farm income and actual income 

```{r, include = FALSE}
Data <- Data %>%
  mutate(cal_farm_income = cal_focus_income + cal_other_crop_income + cal_livestock_income - 
           cal_equipment_costs - cal_farm_other_costs) %>%
  mutate(cal_actual_income = cal_focus_income + cal_other_crop_income + cal_livestock_income - 
           cal_equipment_costs - cal_farm_other_costs + cal_off_farm_labour_income + cal_offfarm_non_labour_income) %>%
  mutate(cal_farm_income = ifelse(is.na(farmer_present)  , NA, cal_farm_income )) %>%
  mutate(cal_actual_income  = ifelse(is.na(farmer_present) , NA, cal_actual_income))

```

# Net promotor score 

```{r, include = FALSE}
hh_farmer_gender <- c("all farmers")
    
    NSP_total <- Data %>%
      select(`repeat no`, cs_recommendation) %>% 
      filter(`repeat no` == 1)%>%
      mutate(cs_recommendation = ifelse(is.na(cs_recommendation), "no input",cs_recommendation)) %>%
      mutate(detractor = ifelse(cs_recommendation == "not likely"| cs_recommendation == "somewhat likely"| cs_recommendation == "likely",1,0),
             promoter = ifelse(cs_recommendation == "very likely", 1,0),
             passive = ifelse(cs_recommendation == "most likely"| cs_recommendation == "i dont know",1,0),
             nr_recommenders = ifelse(cs_recommendation == "no input", 0,1)) %>%
      summarize(nr_promoters = sum(promoter),
                nr_detractors = sum(detractor),
                nr_passive = sum(passive),
                nr_farmers = sum(nr_recommenders)) %>%
      mutate(nsp_total = round((nr_promoters/nr_farmers) - (nr_detractors/nr_farmers),2),
             hh_farmer_gender = hh_farmer_gender)
    
    NSP_by_gender <- Data %>%
      select(`repeat no`, cs_recommendation, hh_farmer_gender) %>% 
      filter(`repeat no` == 1)%>%
      mutate(cs_recommendation = ifelse(is.na(cs_recommendation), "no input",cs_recommendation)) %>%
      mutate(detractor = ifelse(cs_recommendation == "not likely"| cs_recommendation == "somewhat likely"| cs_recommendation == "likely",1,0),
             promoter = ifelse(cs_recommendation == "very likely", 1,0),
             passive = ifelse(cs_recommendation == "most likely"| cs_recommendation == "i dont know",1,0),
             nr_recommenders = ifelse(cs_recommendation == "no input", 0,1)) %>%
      group_by(hh_farmer_gender) %>%
      summarize(nr_promoters = sum(promoter),
                nr_detractors = sum(detractor),
                nr_passive = sum(passive),
                nr_farmers = sum(nr_recommenders)) %>%
      mutate(nsp_gender = round((nr_promoters/nr_farmers) - (nr_detractors/nr_farmers),2))
    
    NSP <- full_join(NSP_total, NSP_by_gender)
    NSP <- NSP %>% select(hh_farmer_gender, nr_farmers, nr_promoters, nr_detractors,nr_passive, nsp_total, nsp_gender)
    
```

# Anonymise data for further use

```{r, include = FALSE}
Data <- Data %>%
          rename(location_cascade_region = pi_location_cascade_level_1) %>%  ### the variable on the right differs from case to case!!!
          select(
      -c(starts_with("pi_"), -contains("county")),
      -c(name_of_farmer, mobile_number_farmer)) %>%
          rename(pi_location_cascade_first_level = location_cascade_region)
  
```


# Summary statistics 

### All Farmers: numerical descriptives

```{r, include = FALSE}
farmer_type <- c("all farmers")
all_var <- Data %>% 
  filter(`repeat no` == 1) %>%
  select(`repeat no`) %>% 
  table() %>% 
  melt(c("farmer type"), value.name="n") %>%
  mutate(`farmer type` = farmer_type)

numerical_descriptives_all_farmers <- Data %>%
  select_if(is.numeric) %>%
  summarise_each(funs(round(mean(., na.rm = TRUE),2))) %>%
  melt(value.name="mean") %>%
  left_join(
    Data %>% 
      select_if(is.numeric) %>%
      summarise_each(funs(round(sd(., na.rm = TRUE),2))) %>%
      melt(value.name="sd")) %>%
  left_join(
    Data %>% 
      select_if(is.numeric) %>%
      summarise_each(funs(min(., na.rm = TRUE))) %>%
      melt(value.name="min")
  ) %>% 
  left_join(
    Data %>% 
      select_if(is.numeric) %>%
      summarise_each(funs(round(max(., na.rm = TRUE),2))) %>%
      melt(value.name="max")
  ) %>% 
  left_join(
    Data %>% 
      select_if(is.numeric) %>%
      summarise_each(funs(count_n))  %>%
      melt(value.name="freq")
  ) %>%
  left_join(survey_questions) %>%
  select("variable", "freq", "mean","sd", "min","max") 

```

### All farmers: single categorical descriptives 

```{r, include = FALSE}
single_mc <- survey_questions %>% 
  filter(type=="option") %>% 
  filter(is.na(multiple)) %>% 
  pull(variable)

single_categorical_descriptives_all_farmers <- all_var

for(i in single_mc){
  
  if(any(names(Data) %in% i)){
    
    frequencies <- Data %>% 
      filter(`repeat no`==1) %>%
      select(all_of(i)) %>%       
      table() %>% 
      melt(c("category"),value.name = "freq") %>%
      mutate(n = nr_participants_raw) %>%
      mutate(`farmer type` = farmer_type) %>%
      mutate("variable" = i) %>%
      left_join(all_var) %>%
      mutate("%" = round(freq/n,2)*100) %>%
      mutate(category = as.character(category))
    
    single_categorical_descriptives_all_farmers <- single_categorical_descriptives_all_farmers %>% 
      full_join(frequencies) %>%
      select(variable, `farmer type`, n, category, freq, "%")
    
  }
}
```

### All farmers: multiple categorical descriptives 

```{r, include = FALSE}
multiple_mc <- survey_questions %>% 
  filter(type=="option") %>% 
  filter(multiple == "yes") %>%
  pull(variable)

multiple_categorical_descriptives_all_farmers <- all_var

for(j in multiple_mc){
  
  if(any(names(Data) %in% j)){
    
    frequencies <- Data %>% 
      select(all_of(j)) %>% 
      cSplit(j, "|") %>%
      gather(key, value) %>%
      select(-key) %>% table() %>%
      melt(c("category"), value.name="freq") %>%
      mutate(n = nr_participants_raw) %>%
      mutate("variable" = j) %>%
      left_join(all_var) %>%
      mutate("%" = round(freq/n,2)*100) %>%
      mutate(category = as.character(category))
    
    multiple_categorical_descriptives_all_farmers <- multiple_categorical_descriptives_all_farmers %>% 
      full_join(frequencies) %>%
      select(variable, `farmer type`, n, category, freq, "%")
    
  }
}

```

### By gender: numerical descriptives 

```{r, include=FALSE}
gender_var <- Data %>% 
  select(hh_farmer_gender) %>% 
  table() %>% 
  melt("hh_farmer_gender", value.name="n")

numerical_descriptives_by_gender <- Data %>%
  group_by(hh_farmer_gender) %>%
  select_if(is.numeric) %>%
  summarise_each(funs(round(mean(., na.rm = TRUE),2))) %>%
  melt(value.name="mean") %>%
  left_join(
    Data %>% 
      group_by(hh_farmer_gender) %>%
      select_if(is.numeric) %>%
      summarise_each(funs(round(sd(., na.rm = TRUE),2))) %>%
      melt(value.name="sd")) %>%
  left_join(
    Data %>% 
      group_by(hh_farmer_gender) %>%
      select_if(is.numeric) %>%
      summarise_each(funs(min(., na.rm = TRUE))) %>%
      melt(value.name="min")
  ) %>% 
  left_join(
    Data %>% 
      group_by(hh_farmer_gender) %>%
      select_if(is.numeric) %>%
      summarise_each(funs(round(max(., na.rm = TRUE),2))) %>%
      melt(value.name="max")
  ) %>% 
  left_join(
    Data %>% 
      group_by(hh_farmer_gender) %>%
      select_if(is.numeric) %>%
      summarise_each(funs(count_n))  %>%
      melt(value.name="freq")
  ) %>%
  left_join(survey_questions) %>%
  left_join(gender_var) %>%
  select("variable","hh_farmer_gender","n", "freq", "mean","sd", "min","max") 

```

### By gender: single categorical descriptives 

```{r, include = FALSE}
single_mc <- survey_questions %>% 
  filter(type=="option") %>% 
  filter(is.na(multiple)) %>% 
  filter(variable != "hh_farmer_gender") %>%
  pull(variable)

single_categorical_descriptives_by_gender <- gender_var

for(i in single_mc){
  
  if(any(names(Data) %in% i)){
    
    frequencies <- Data %>% 
      select(hh_farmer_gender, all_of(i)) %>% 
      table() %>% 
      melt(c("hh_farmer_gender","category"), value.name="freq") %>%
      mutate("variable" = i) %>%
      left_join(gender_var) %>%
      mutate("%" = round(freq/n,2)*100) %>%
      mutate(category = as.character(category))
    
    single_categorical_descriptives_by_gender <- single_categorical_descriptives_by_gender %>% 
      full_join(frequencies) %>%
      select(variable, hh_farmer_gender, n, category, freq, "%")
  }
}
```

### By gender: multiple categorical descriptives 

```{r, include = FALSE}
multiple_mc <- survey_questions %>% 
  filter(type=="option") %>% 
  filter(multiple == "yes") %>%
  pull(variable)

multiple_categorical_descriptives_by_gender <- gender_var

for(j in multiple_mc){
  
  if(any(names(Data) %in% j)){
    
    frequencies <- Data %>% 
      select(hh_farmer_gender, all_of(j)) %>% 
      cSplit(j, "|") %>%
      gather(key, value, -hh_farmer_gender) %>%
      select(-key) %>% table() %>%
      melt(c("hh_farmer_gender","category"), value.name="freq") %>%
      mutate("variable" = j) %>%
      left_join(gender_var) %>%
      mutate("%" = round(freq/n,2)*100) %>%
      mutate(category = as.character(category))
    
    multiple_categorical_descriptives_by_gender <- multiple_categorical_descriptives_by_gender %>% 
      full_join(frequencies) %>%
      select(variable, hh_farmer_gender, n, category, freq, "%")
  }
}
```


# Remove repeated rows

Remove repeated rows for household members and create columns for each household member (max household number is 15). Delete the unnecessary, only if household roster questions are asked, check also which ones are used. 
 
```{r, include = FALSE}
if("identifier" %in% colnames(Data)){     
    Data <- Data %>%
      group_by(identifier) %>%
      mutate(id = row_number())
    
    for (nr in c(1:15)){
      
      ### ---- delete the unnecessary --- only if household roster questions are asked, check also which ones are used
      hh_member_birthyear_nr <- paste0("hh_member_birthyear_", nr)
      hh_member_gender_nr <- paste0("hh_member_gender_", nr)
      hh_member_education_nr <- paste0("hh_member_education_", nr)
      hh_unpaidlabour_hhactivities_nr <- paste0("hh_unpaidlabour_hhactivities_", nr)
      hh_focuscrop_nr <- paste0("hh_focuscrop_", nr)
      hh_otherfarm_activities_nr <- paste0("hh_otherfarm_activities_", nr)
      hh_offarmlabour_activities_nr <- paste0("hh_offarmlabour_activities_", nr)
      
      Data <- Data %>%
        #Delete the rows that do not apply
        mutate(!!sym(hh_member_birthyear_nr) := ifelse(id == nr, hh_member_birthyear, NA),
          !!sym(hh_member_gender_nr) := ifelse(id == nr, hh_member_gender, NA),
          !!sym(hh_member_education_nr) := ifelse(id == nr, hh_member_education, NA),
          !!sym(hh_unpaidlabour_hhactivities_nr) := ifelse(id == nr, hh_unpaidlabour_hhactivities_hrs, NA),
          !!sym(hh_focuscrop_nr) := ifelse(id == nr, hh_focuscrop_hrs, NA),
          !!sym(hh_otherfarm_activities_nr) := ifelse(id == nr, hh_otherfarm_activities_hrs, NA),
          !!sym(hh_offarmlabour_activities_nr) := ifelse(id == nr, hh_offarmlabour_activities_hrs, NA),) %>%
        
        #Delete the rows that do not apply
        fill(!!sym(hh_member_birthyear_nr)) %>%
        fill(!!sym(hh_member_birthyear_nr), .direction = "up") %>%
        fill(!!sym(hh_member_gender_nr)) %>%
        fill(!!sym(hh_member_gender_nr), .direction = "up") %>%
        fill(!!sym(hh_member_education_nr)) %>%
        fill(!!sym(hh_member_education_nr), .direction = "up") %>%
        fill(!!sym(hh_unpaidlabour_hhactivities_nr)) %>%
        fill(!!sym(hh_unpaidlabour_hhactivities_nr), .direction = "up") %>%
        fill(!!sym(hh_focuscrop_nr)) %>%
        fill(!!sym(hh_focuscrop_nr), .direction = "up") %>%
        fill(!!sym(hh_otherfarm_activities_nr)) %>%
        fill(!!sym(hh_otherfarm_activities_nr), .direction = "up") %>%
        fill(!!sym(hh_offarmlabour_activities_nr)) %>%
        fill(!!sym(hh_offarmlabour_activities_nr), .direction = "up") %>%
        
        #Delete the rows that do not apply
        mutate(!!sym(hh_member_birthyear_nr) := ifelse(id >1 , NA, !!sym(hh_member_birthyear_nr) ),
          !!sym(hh_member_gender_nr) := ifelse(id >1 , NA, !!sym(hh_member_gender_nr) ),
          !!sym(hh_member_education_nr) := ifelse(id >1 , NA, !!sym(hh_member_education_nr) ),
          !!sym(hh_unpaidlabour_hhactivities_nr) := ifelse(id >1 , NA, !!sym(hh_unpaidlabour_hhactivities_nr) ),
          !!sym(hh_focuscrop_nr) := ifelse(id >1 , NA, !!sym(hh_focuscrop_nr) ),
          !!sym(hh_otherfarm_activities_nr) := ifelse(id >1 , NA, !!sym(hh_otherfarm_activities_nr) ),
          !!sym(hh_offarmlabour_activities_nr) := ifelse(id >1 , NA, !!sym(hh_offarmlabour_activities_nr) ))
      
    }
  }
  
  Data <- Data %>%
    filter(id == 1) %>%
    select(-id,
           #-hh_member_birthyear,
           #-hh_member_gender,
           #-hh_member_education,
           -hh_unpaidlabour_hhactivities_hrs,
           -hh_focuscrop_hrs,
           -hh_otherfarm_activities_hrs,
           -hh_offarmlabour_activities_hrs)
  
```

# Check completeness of codebook 

All variables that are in the data should get a description in the codebook. That's why we check this and correct/ add where missing. We also check whether we have all the variables that are required for the data delivery.

```{r, include = FALSE}
question_library <- question_library %>%
    dplyr::rename(section = "Title",
                  question = "Text", 
                  variable = "Variable name",
                  type = "Question type",
                  options = "Options",
                  multiple = "Allow multiple") %>%
    mutate_all(tolower) %>%
    select(section,
           question,
           variable,
           type,
           options,
           multiple) %>%
    fill(section)
  
unmatched <- list()
```

Let's check the variable names. First we need a dataframe with all variable names, and

```{r, include = FALSE}
#Make a dataframe listing all variables 
variable <-ls(Data)
data <- data.frame(variable)

## ---- Variables ending with other  ---

#Check if data variable is in codebook        
data$compare <-data$variable  %in%  survey_questions$variable 

#if it's a "other variable", do not remove
data <- data %>%
  mutate(compare = ifelse(grepl('_other$',variable) & compare == FALSE , FALSE, TRUE)) %>%
  filter(compare == FALSE) 

survey_questions <- bind_rows(survey_questions, data)
survey_questions <- survey_questions %>%
  arrange(variable)  %>%
  fill(question,
       section) %>%
  mutate(type = ifelse(!is.na(compare), "free text",type)) %>%
  
  mutate(variable_2 = str_remove(variable,'_other$')) %>%
  mutate(same = ifelse(variable_2== lag(variable_2), 1, 0)) %>%
  
  mutate(section = ifelse(!is.na(compare) & same == 0 , "unknown", section),
         question = ifelse(!is.na(compare) & same == 0 , "no question available", question)) %>%
  select(-compare, -variable_2, -same)

```

Check if it is a calculated variable or a variable from the question library.

```{r}
variable <-ls(Data)
data <- data.frame(variable)
data$compare <-data$variable  %in%  survey_questions$variable 
data <- data %>%
  filter(compare == FALSE) %>%
  select(-compare)

data$compare <-data$variable  %in%  vars_transformed$variable 

#check whether there is a match by checking out the "data" dataset MANUALLY
#if a variable is not in the vars_transformed, update the excel with variable transformations
```

Append the survey questions with the calculated variables

```{r}
#One changes are applied, append the codebook with information from the calculated variables (vars_transformed)
library(dplyr)

# Assuming "data" and "vars_transformed" are your dataframes

vars_calculated <- data$variable

calculated_variables <- vars_transformed %>%
  filter(variable %in% vars_calculated)

survey_questions <- survey_questions %>%
  bind_rows(calculated_variables)

```

Check whether its a household demographics variable

```{r}
#Check whether already in the codebook
variable <-ls(Data)
data <- data.frame(variable)
data$compare <-data$variable  %in%  survey_questions$variable 
data <- data %>%
  filter(compare == FALSE) 

```

If indeed household demographics variable, append the codebook with that information

```{r}
data <- data %>%
  filter(variable %in% household_demographics$variable) %>%
  select(-compare)

data <- merge(data, household_demographics, by.x = "variable")
survey_questions <- bind_rows(survey_questions, data)
```

```{r, include = FALSE}
# --- Check household demographic questions ---
  hh_demo <- survey_questions %>%
    filter(str_detect(variable, 'hh_member_')) %>%
    arrange(variable) %>%
    fill(section, options)
  
  survey_questions <- survey_questions %>%
    filter(!str_detect(variable, 'hh_member_')) 
  survey_questions <- bind_rows(survey_questions, hh_demo)
  
```

Check whether we have all the required variables for the portal

```{r}
# ---- dashboard variables ----
  #All variables in delivered data into dataframe
  
  variable <-ls(Data)
  data <- data.frame(variable)
  
  #Check if data variable is dashboard list     
  vars_dashboard$compare <- vars_dashboard$latest_var %in% data$variable 
  
  data <- vars_dashboard %>%
    filter(!is.na(latest_var)) %>%
    filter(compare == FALSE) %>%
    filter(is.na(note))
  

```

Prepare final list of unmatched vars

-   Check these by hand and ensure the variable names are aligned with

1)  the question library

2)  list of calculated variables

3)  Household demographic variables.

Ensure that all variables part of the cleaned data or dashboard variable names are described in the codebook.

```{r, include = FALSE}
variable <- ls(Data)
data <- data.frame(variable) %>%
  filter(
    !variable %in% c(survey_questions$variable, vars_transformed$variable, question_library$variable)
  )

```

# Combine the inputs for data delivery

```{r}
# Delete last irrelevant variables
Data <- Data %>% select(-c(`repeat no`, "0-0"))

sets <- list(
    "Codebook" = survey_questions,
    "Cleaned Data" = Data,
    "Raw Data (anonymised)" = Data_raw, 
    "Num. desc. all farmers" = numerical_descriptives_all_farmers,
    "Cat. desc. single all farmers" = single_categorical_descriptives_all_farmers,
    "Cat. desc. multi all farmers" = multiple_categorical_descriptives_all_farmers,
    "Num. desc. by gender" = numerical_descriptives_by_gender,
    "Cat. desc. single by gender" = single_categorical_descriptives_by_gender,
    "Cat. desc. multi by gender" = multiple_categorical_descriptives_by_gender,
    "Net promoter score" = NSP)
  
  write.xlsx (sets, file = (paste0(data_delivery)))
```

# Get personal information sheet

```{r, include = FALSE}
## ---- Extract personal information ----
Data_raw <- read_excel(data_filename)

Data_raw <- Data_raw %>%
  select(-contains("--option--")) %>%
  rename_all(funs(tolower)) %>%
  filter(`repeat no`==1) %>%
  select(identifier,
         name_of_farmer,
         mobile_number_farmer,
         contains("pi_")) #-contains("ppi")) 


pi_info<- list("Personal information" = Data_raw)
write.xlsx(pi_info, file="pi_2022_CHC_maize_soybean.xlsx")

```


#Productivity check 

```{r}
productivity <- Data %>%
    mutate(maize_product_min_sold = cal_maize_quant_prod_kg - cal_maize_quant_sold_kg) %>%
    mutate(soybean_product_min_sold = cal_soybean_quant_prod_kg - cal_soybean_quant_sold_kg) %>%

    select(identifier,
           submitter,
           `submission date`, ##MAKE SURE THIS VARIABLE IS NOT DELETED IN THE FIRST PIECE OF THE CODE.It should be deleted before sharing with IDH, but it should be kept when checking the productivity numbers.
           starts_with("pi_location_cascade_level"), #include the applicable variable, this differs per case
           focus_crop_maize_soybean,
           f_maize_quant_prod,
           f_maize_measurement_prod,
           f_maize_crop_size,
           f_maize_size_acre,
           cal_maize_productivity_acre,
           f_maize_quant_sold,
           maize_product_min_sold,
           f_maize_price,
           
           f_soybean_quant_prod,
           f_soybean_measurement_prod,
           f_soybean_crop_size,
           f_soybean_size_acre,
           cal_soybean_productivity_acre,
           f_soybean_quant_sold,
           soybean_product_min_sold,
           f_soybean_price)
  
write.xlsx (productivity, file = "productivity_check_3.xlsx", overwrite = TRUE)
```

